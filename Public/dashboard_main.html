<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MomentumScout Player Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
    .attribute-slider {
      -webkit-appearance: none; appearance: none; width: 100%; height: 8px;
      background: #21262d; outline: none; border-radius: 4px; transition: opacity .2s;
    }
    .attribute-slider:hover { opacity: 1; }
    .attribute-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 16px; height: 16px; background: #22c55e;
      cursor: pointer; border-radius: 50%;
    }
    .modal {
      display: none; position: fixed; z-index: 100; left: 0; top: 0;
      width: 100%; height: 100%; background-color: rgba(0,0,0,0.85);
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #22c55e;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="bg-gray-900 text-gray-100 p-6 min-h-screen flex flex-col items-center">

  <!-- Access Code -->
  <script>
    const password = prompt("Enter your access code:");
    if (password !== "SCOUT2025") {
      alert("Access denied.");
      window.location.href = "index.html";
    }
  </script>

  <!-- Player Modal -->
  <div id="playerModal" class="modal">
    <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-lg mx-auto mt-20 relative">
      <span id="closeModal" class="absolute top-2 right-4 text-3xl cursor-pointer text-gray-400 hover:text-white">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- Dashboard Container -->
  <div class="container mx-auto p-8 bg-gray-800 rounded-2xl shadow-2xl space-y-8 border border-gray-700 w-full max-w-4xl">

    <!-- Header -->
    <div class="text-center">
      <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-teal-500 mb-2">MomentumScout</h1>
      <h2 class="text-lg text-gray-400">Player Scouting & Value Engine</h2>
    </div>

    <!-- Player Search -->
    <div class="bg-gray-700 p-6 rounded-xl border border-gray-600 space-y-4">
      <h3 class="text-2xl font-semibold text-green-400">Search for a Player</h3>
      <div class="flex space-x-2">
        <input id="playerNameSearch" type="text" placeholder="e.g. Kylian Mbappé" class="w-full bg-gray-600 text-gray-100 rounded-md p-2 border border-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500">
        <button id="searchPlayerBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-gray-900 font-semibold rounded-lg shadow-md transition">Search</button>
      </div>
      <div id="playerSearchResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4"></div>
    </div>

    <!-- Scouting Profile -->
    <div class="bg-gray-700 p-6 rounded-xl border border-gray-600 space-y-4">
      <h3 class="text-2xl font-semibold text-green-400">Scouting Profile</h3>

      <div>
        <label for="position" class="text-sm font-medium block mb-2">Position</label>
        <select id="position" class="w-full bg-gray-600 text-gray-100 rounded-md p-2 border border-gray-500 focus:ring-2 focus:ring-green-500">
          <option value="GK">Goalkeeper</option>
          <option value="CB">Centre Back</option>
          <option value="LB">Left Back</option>
          <option value="RB">Right Back</option>
          <option value="CDM">Defensive Midfielder</option>
          <option value="CM">Central Midfielder</option>
          <option value="CAM">Attacking Midfielder</option>
          <option value="RW">Right Winger</option>
          <option value="LW">Left Winger</option>
          <option value="CF">Centre Forward</option>
          <option value="ST">Striker</option>
        </select>
      </div>

      <div id="dynamicMetrics" class="space-y-6"></div>
      <div id="weightingSliders" class="space-y-4 mt-6"></div>

      <div class="flex justify-center space-x-4 mt-8">
        <button id="findPlayersBtn" class="px-6 py-2 bg-green-500 hover:bg-green-600 text-gray-900 font-semibold rounded-lg">Find Players</button>
        <button id="resetBtn" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-gray-900 font-semibold rounded-lg">Reset</button>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsSection" class="bg-gray-700 p-6 rounded-xl border border-gray-600">
      <h3 class="text-2xl font-semibold mb-4 text-green-400 text-center">Top Player Recommendations</h3>
      <div id="loadingIndicator" class="hidden flex justify-center py-8"><div class="spinner"></div></div>
      <div id="recommendations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ✅ Use your Render backend here
      const BACKEND_URL = "https://momentumai-backend-g1ov.onrender.com";

      const posSelect = document.getElementById("position");
      const dynMetrics = document.getElementById("dynamicMetrics");
      const weightContainer = document.getElementById("weightingSliders");
      const results = document.getElementById("recommendations");
      const searchBtn = document.getElementById("searchPlayerBtn");
      const findBtn = document.getElementById("findPlayersBtn");
      const resetBtn = document.getElementById("resetBtn");
      const loader = document.getElementById("loadingIndicator");
      const modal = document.getElementById("playerModal");
      const modalClose = document.getElementById("closeModal");
      const modalContent = document.getElementById("modalContent");
      const playerSearchResults = document.getElementById("playerSearchResults");

      modalClose.onclick = () => modal.style.display = "none";
      window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };

      const POSITION_METRICS = {
        'GK': {
                   display: ['goalkeeping_diving', 'goalkeeping_handling', 'goalkeeping_kicking', 'goalkeeping_positioning', 'goalkeeping_reflexes'],
                   weights: ['goalkeeping_diving', 'goalkeeping_handling', 'goalkeeping_kicking', 'goalkeeping_positioning', 'goalkeeping_reflexes']
               },
               'CB': {
                   display: ['pace', 'passing', 'defending', 'power_strength', 'power_jumping', 'mentality_interceptions', 'mentality_positioning', 'defending_marking_awareness', 'defending_standing_tackle', 'defending_sliding_tackle', 'attacking_crossing'],
                   weights: ['pace', 'passing', 'defending']
               },
               'LB': {
                   display: ['pace', 'passing', 'defending', 'power_strength', 'power_jumping', 'mentality_interceptions', 'mentality_positioning', 'defending_marking_awareness', 'defending_standing_tackle', 'defending_sliding_tackle', 'attacking_crossing'],
                   weights: ['pace', 'passing', 'defending']
               },
               'RB': {
                   display: ['pace', 'passing', 'defending', 'power_strength', 'power_jumping', 'mentality_interceptions', 'mentality_positioning', 'defending_marking_awareness', 'defending_standing_tackle', 'defending_sliding_tackle', 'attacking_crossing'],
                   weights: ['pace', 'passing', 'defending']
               },
               'CDM': {
                   display: ['pace', 'passing', 'dribbling', 'defending', 'physic', 'mentality_interceptions', 'mentality_positioning', 'defending_standing_tackle', 'defending_sliding_tackle'],
                   weights: ['pace', 'passing', 'dribbling', 'defending', 'physic']
               },
               'CM': {
                   display: ['pace', 'passing', 'dribbling', 'defending', 'physic', 'power_stamina', 'power_strength', 'mentality_vision'],
                   weights: ['pace', 'passing', 'dribbling', 'defending', 'physic']
               },
               'CAM': {
                   display: ['pace', 'shooting', 'passing', 'dribbling', 'power_long_shots', 'mentality_vision', 'mentality_penalties'],
                   weights: ['pace', 'shooting', 'passing', 'dribbling']
               },
               'RW': {
                   display: ['pace', 'shooting', 'passing', 'dribbling', 'power_long_shots', 'skill_curve', 'skill_fk_accuracy', 'movement_acceleration', 'movement_sprint_speed'],
                   weights: ['pace', 'shooting', 'passing', 'dribbling']
               },
               'LW': {
                   display: ['pace', 'shooting', 'passing', 'dribbling', 'power_long_shots', 'skill_curve', 'skill_fk_accuracy', 'movement_acceleration', 'movement_sprint_speed'],
                   weights: ['pace', 'shooting', 'passing', 'dribbling']
               },
               'CF': {
                   display: ['pace', 'shooting', 'passing', 'dribbling', 'power_shot_power', 'power_jumping', 'mentality_positioning', 'mentality_composure'],
                   weights: ['pace', 'shooting', 'passing', 'dribbling']
               },
               'ST': {
                   display: ['pace', 'shooting', 'dribbling', 'power_shot_power', 'power_jumping', 'power_strength', 'mentality_positioning', 'attacking_finishing'],
                   weights: ['pace', 'shooting', 'dribbling']
               }
           };


      function createSlider(attr, min, max, valMin, valMax) {
        return `
          <div>
            <label class="block text-sm mb-1">${attr}: <span id="${attr}Val">${valMin} - ${valMax}</span></label>
            <input id="${attr}_min" type="range" min="${min}" max="${max}" value="${valMin}" class="attribute-slider mb-2">
            <input id="${attr}_max" type="range" min="${min}" max="${max}" value="${valMax}" class="attribute-slider">
          </div>`;
      }

      function createWeightSlider(attr) {
        return `
          <div>
            <label>${attr} Weight: <span id="w_${attr}_val">50</span></label>
            <input id="w_${attr}" type="range" min="0" max="100" value="50" class="attribute-slider">
          </div>`;
      }

      function generateSliders() {
        const pos = posSelect.value;
        const metrics = POSITION_METRICS[pos] || [];
        dynMetrics.innerHTML = metrics.map(m => createSlider(m, 0, 99, 50, 90)).join('');
        weightContainer.innerHTML = metrics.map(m => createWeightSlider(m)).join('');
        setupSliderListeners();
      }

      function setupSliderListeners() {
        document.querySelectorAll('input[type="range"]').forEach(sl => {
          sl.oninput = () => {
            const id = sl.id.replace('_min', '').replace('_max', '');
            const span = document.getElementById(sl.id.includes('w_') ? `${sl.id}_val` : `${id}Val`);
            if (span) {
              if (sl.id.includes('w_')) span.textContent = sl.value;
              else {
                const min = document.getElementById(`${id}_min`)?.value || 0;
                const max = document.getElementById(`${id}_max`)?.value || 0;
                span.textContent = `${min} - ${max}`;
              }
            }
          };
        });
      }

      async function safeFetch(endpoint, data) {
        try {
          const res = await fetch(`${BACKEND_URL}${endpoint}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            mode: "cors"
          });
          if (!res.ok) throw new Error(`Server error ${res.status}`);
          return await res.json();
        } catch (err) {
          console.error("❌ Fetch error:", err);
          alert("Backend connection issue. Try again shortly.");
          return { error: true };
        }
      }

      findBtn.onclick = async () => {
        loader.classList.remove("hidden");
        results.innerHTML = "";
        const payload = { club_position: posSelect.value, weights: {} };
        document.querySelectorAll('input[type="range"]').forEach(sl => {
          if (sl.id.startsWith("w_")) payload.weights[sl.id.replace("w_", "")] = parseInt(sl.value);
          else payload[sl.id] = parseFloat(sl.value);
        });
        const res = await safeFetch("/find_players", payload);
        loader.classList.add("hidden");
        displayPlayers(res.players || [], results);
      };

      searchBtn.onclick = async () => {
        const name = document.getElementById("playerNameSearch").value;
        if (!name) return alert("Enter player name");
        loader.classList.remove("hidden");
        playerSearchResults.innerHTML = "";
        const res = await safeFetch("/search_player", { player_name: name });
        loader.classList.add("hidden");
        displayPlayers(res || [], playerSearchResults);
      };

      function displayPlayers(players, container) {
        container.innerHTML = players.length
          ? players.map(p => `
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-600 text-center hover:scale-105 transition-transform cursor-pointer">
              <img src="${p.player_face_url || ''}" class="w-20 h-20 rounded-full mx-auto border-2 border-green-500 mb-3">
              <h4 class="text-lg font-bold text-green-400">${p.short_name}</h4>
              <p class="text-gray-400">${p.club_position} | OVR: ${p.overall}</p>
              <p class="text-gray-500 text-sm">Value: £${(p.value_eur/1_000_000).toFixed(2)}M</p>
            </div>`).join('')
          : "<div class='text-center text-gray-400 col-span-full'>No results found.</div>";
      }

      generateSliders();
    });
  </script>

</body>
</html>
