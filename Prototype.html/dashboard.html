<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MomentumScout Player Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family:'Inter',sans-serif; background:#0d1117; color:#c9d1d9; }
  .container { max-width:1200px; }
  .attribute-slider { -webkit-appearance:none; appearance:none; width:100%; height:8px; background:#21262d; outline:none; opacity:0.7; transition:opacity .2s; border-radius:4px;}
  .attribute-slider:hover{opacity:1;}
  .attribute-slider::-webkit-slider-thumb{ -webkit-appearance:none; width:16px;height:16px;background:#2e8b57;border-radius:50%;cursor:pointer;}
  .attribute-slider::-moz-range-thumb{ width:16px;height:16px;background:#2e8b57;border-radius:50%;cursor:pointer;}
  .modal{ display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.8);}
  .modal-content{ margin:5% auto; width:90%; max-width:600px;}
  .close-button{ color:#aaa; float:right; font-size:28px; font-weight:bold; }
  .close-button:hover{ color:#fff; cursor:pointer; }
  .spinner{ border:4px solid rgba(255,255,255,0.3); border-top:4px solid #2e8b57; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite;}
  @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
</style>
</head>
<body class="bg-gray-900 text-gray-100 p-6 min-h-screen flex flex-col items-center">

<div id="playerModal" class="modal">
  <div class="modal-content bg-gray-800 p-6 rounded-lg shadow-lg relative">
    <span class="close-button absolute top-2 right-4 text-3xl cursor-pointer">&times;</span>
    <div id="modalContent" class="text-gray-100"></div>
  </div>
</div>

<div class="container mx-auto p-8 bg-gray-800 rounded-2xl shadow-2xl space-y-8 border border-gray-700 w-full max-w-4xl">
  <div class="text-center">
    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-teal-500 mb-2">MomentumScout</h1>
    <h2 class="text-xl text-gray-400">Player Scouting & Value Engine</h2>
  </div>

  <div class="bg-gray-700 p-6 rounded-xl shadow-inner border border-gray-600 space-y-4">
    <h3 class="text-2xl font-semibold text-green-400">Search for a Player</h3>
    <div class="flex space-x-2">
      <input type="text" id="playerNameSearch" placeholder="e.g., Lionel Messi" class="w-full bg-gray-600 text-gray-100 rounded-md p-2 border border-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500">
      <button id="searchPlayerBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-gray-900 font-semibold rounded-lg shadow-md transition duration-200">Search</button>
    </div>
    <div id="playerSearchRecommendations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4"></div>
  </div>

  <div class="bg-gray-700 p-6 rounded-xl shadow-inner border border-gray-600">
    <h3 class="text-2xl font-semibold mb-6 text-green-400">Scouting Profile</h3>

    <div class="mb-6">
      <label for="position" class="text-sm font-medium block mb-2">Position</label>
      <select id="position" class="w-full bg-gray-600 text-gray-100 rounded-md p-2 border border-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500">
        <option value="GK">Goalkeeper</option>
        <option value="RB">Right Back</option>
        <option value="LB">Left Back</option>
        <option value="CB">Centre Back</option>
        <option value="CDM">Defensive Midfielder</option>
        <option value="CM">Midfielder</option>
        <option value="CAM">Attacking Midfielder</option>
        <option value="RW">Right Winger</option>
        <option value="LW">Left Winger</option>
        <option value="CF">Centre Forward</option>
        <option value="ST">Striker</option>
      </select>
    </div>

    <div class="space-y-6">
      <div>
        <label for="overall_min" class="block text-sm mb-1">Overall: <span id="overallValue">75 - 95</span></label>
        <input type="range" id="overall_min" min="50" max="99" value="75" class="attribute-slider w-full">
        <input type="range" id="overall_max" min="50" max="99" value="95" class="attribute-slider w-full">
      </div>
      <div>
        <label for="age_min" class="block text-sm mb-1">Age: <span id="ageValue">20 - 30</span></label>
        <input type="range" id="age_min" min="16" max="45" value="20" class="attribute-slider w-full">
        <input type="range" id="age_max" min="16" max="45" value="30" class="attribute-slider w-full">
      </div>
      <div>
        <label for="value_min" class="block text-sm mb-1">Value (MÂ£): <span id="valueValue">1 - 50</span></label>
        <input type="range" id="value_min" min="0.1" max="999" step="0.1" value="1" class="attribute-slider w-full">
        <input type="range" id="value_max" min="0.1" max="999" step="0.1" value="50" class="attribute-slider w-full">
      </div>
    </div>

    <div id="dynamicMetrics" class="space-y-6 mt-6"></div>
    <div id="weightingSliders" class="space-y-4 mt-6"><h4 class="text-lg font-semibold text-green-400">Desired Attribute Focus</h4></div>

    <div class="flex justify-center space-x-4 mt-8">
      <button id="findPlayersBtn" class="px-6 py-2 bg-green-500 hover:bg-green-600 text-gray-900 font-semibold rounded-lg shadow-md transition duration-200">Find Top Players</button>
      <button id="resetBtn" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-gray-900 font-semibold rounded-lg shadow-md transition duration-200">Reset All</button>
    </div>
  </div>

  <div id="resultsSection" class="bg-gray-700 p-6 rounded-xl shadow-inner border border-gray-600">
    <h3 class="text-2xl font-semibold mb-4 text-green-400 text-center">Top Player Recommendations</h3>
    <div id="loadingIndicator" class="hidden flex justify-center py-8"><div class="spinner"></div></div>
    <div id="recommendations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const BACKEND_URL = 'https://momentumai-backend-g1ov.onrender.com';
  const findPlayersBtn = document.getElementById('findPlayersBtn');
  const searchPlayerBtn = document.getElementById('searchPlayerBtn');
  const resetBtn = document.getElementById('resetBtn');
  const recommendationsContainer = document.getElementById('recommendations');
  const playerSearchRecommendations = document.getElementById('playerSearchRecommendations');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const positionSelect = document.getElementById('position');
  const dynamicMetricsContainer = document.getElementById('dynamicMetrics');
  const weightingSlidersContainer = document.getElementById('weightingSliders');

  const POSITION_METRICS = {
    GK:{display:['goalkeeping_diving','goalkeeping_handling','goalkeeping_kicking','goalkeeping_positioning','goalkeeping_reflexes'],weights:['goalkeeping_diving','goalkeeping_handling','goalkeeping_kicking','goalkeeping_positioning','goalkeeping_reflexes']},
    CB:{display:['pace','passing','defending','power_strength','power_jumping','mentality_interceptions','mentality_positioning','defending_marking_awareness','defending_standing_tackle','defending_sliding_tackle','attacking_crossing'],weights:['pace','passing','defending']},
    LB:{display:['pace','passing','defending','power_strength','power_jumping','mentality_interceptions','mentality_positioning','defending_marking_awareness','defending_standing_tackle','defending_sliding_tackle','attacking_crossing'],weights:['pace','passing','defending']},
    RB:{display:['pace','passing','defending','power_strength','power_jumping','mentality_interceptions','mentality_positioning','defending_marking_awareness','defending_standing_tackle','defending_sliding_tackle','attacking_crossing'],weights:['pace','passing','defending']},
    CDM:{display:['pace','passing','dribbling','defending','physic','mentality_interceptions','mentality_positioning','defending_standing_tackle','defending_sliding_tackle'],weights:['pace','passing','dribbling','defending','physic']},
    CM:{display:['pace','passing','dribbling','defending','physic','power_stamina','power_strength','mentality_vision'],weights:['pace','passing','dribbling','defending','physic']},
    CAM:{display:['pace','shooting','passing','dribbling','power_long_shots','mentality_vision','mentality_penalties'],weights:['pace','shooting','passing','dribbling']},
    RW:{display:['pace','shooting','passing','dribbling','power_long_shots','skill_curve','skill_fk_accuracy','movement_acceleration','movement_sprint_speed'],weights:['pace','shooting','passing','dribbling']},
    LW:{display:['pace','shooting','passing','dribbling','power_long_shots','skill_curve','skill_fk_accuracy','movement_acceleration','movement_sprint_speed'],weights:['pace','shooting','passing','dribbling']},
    CF:{display:['pace','shooting','passing','dribbling','power_shot_power','power_jumping','mentality_positioning','mentality_composure'],weights:['pace','shooting','passing','dribbling']},
    ST:{display:['pace','shooting','dribbling','power_shot_power','power_jumping','power_strength','mentality_positioning','attacking_finishing'],weights:['pace','shooting','dribbling']}
  };

  function generateDynamicSliders(){
    const pos = positionSelect.value;
    const metrics = POSITION_METRICS[pos] ? POSITION_METRICS[pos].display : [];
    dynamicMetricsContainer.innerHTML = '';
    const weightMetrics = POSITION_METRICS[pos] ? POSITION_METRICS[pos].weights : [];
    let weightHtml = ['<h4 class="text-lg font-semibold text-green-400">Desired Attribute Focus</h4>'];
    metrics.forEach(m => {
      const label = m.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
      dynamicMetricsContainer.innerHTML += `
        <div>
          <label for="${m}_min" class="block text-sm mb-1">${label}: <span id="${m}Value">0 - 99</span></label>
          <input type="range" id="${m}_min" min="0" max="99" value="0" class="attribute-slider w-full">
          <input type="range" id="${m}_max" min="0" max="99" value="99" class="attribute-slider w-full">
        </div>`;
    });
    if (pos === 'GK') weightHtml.push(`<p class="text-sm text-center text-gray-400">Goalkeeper attributes are not weighted for scouting score.</p>`);
    else weightMetrics.forEach(m => {
      const label = m.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
      weightHtml.push(`<div><label for="weight_${m}" class="block text-sm mb-1">${label} Desire: <span id="weight${m.charAt(0).toUpperCase()+m.slice(1)}Value">0</span></label><input type="range" id="weight_${m}" min="0" max="100" value="0" class="attribute-slider w-full"></div>`);
    });
    weightingSlidersContainer.innerHTML = weightHtml.join('');
    attachSliderListeners();
  }

  function attachSliderListeners(){
    document.querySelectorAll('input[type="range"]').forEach(s => s.addEventListener('input', updateSliderValues));
  }
  function updateSliderValues(){
    document.querySelectorAll('input[id$="_min"]').forEach(min => {
      const max = document.getElementById(min.id.replace('_min','_max'));
      const span = document.getElementById(min.id.replace('_min','Value'));
      if (span && max) span.textContent = `${min.value} - ${max.value}`;
    });
    document.querySelectorAll('input[id^="weight_"]').forEach(s => {
      const idShort = s.id.replace('weight_','');
      const span = document.getElementById(`weight${idShort.charAt(0).toUpperCase()+idShort.slice(1)}Value`);
      if (span) span.textContent = s.value;
    });
  }

  function resetDashboard(){
    document.getElementById('overall_min').value='75'; document.getElementById('overall_max').value='95';
    document.getElementById('age_min').value='20'; document.getElementById('age_max').value='30';
    document.getElementById('value_min').value='1'; document.getElementById('value_max').value='50';
    positionSelect.value='GK'; document.getElementById('playerNameSearch').value=''; recommendationsContainer.innerHTML=''; playerSearchRecommendations.innerHTML='';
    generateDynamicSliders();
  }

  positionSelect.addEventListener('change', generateDynamicSliders);
  resetBtn.addEventListener('click', resetDashboard);

  findPlayersBtn.addEventListener('click', async () => {
    loadingIndicator.classList.remove('hidden'); recommendationsContainer.innerHTML=''; playerSearchRecommendations.innerHTML='';
    const scoutingProfile = {};
    document.querySelectorAll('input[type="range"]').forEach(slider => {
      if (slider.id.startsWith('weight_')) {
        if (!scoutingProfile.weights) scoutingProfile.weights = {};
        scoutingProfile.weights[slider.id.replace('weight_','')] = parseInt(slider.value);
      } else {
        scoutingProfile[slider.id] = parseFloat(slider.value);
      }
    });
    scoutingProfile.club_position = positionSelect.value;
    scoutingProfile.value_min = (scoutingProfile.value_min || 0) * 1000000;
    scoutingProfile.value_max = (scoutingProfile.value_max || 0) * 1000000;

    try {
      const res = await fetch(`${BACKEND_URL}/api/find_players`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(scoutingProfile) });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      loadingIndicator.classList.add('hidden');
      displayRecommendations(data.players || [], recommendationsContainer);
    } catch (err) {
      loadingIndicator.classList.add('hidden');
      recommendationsContainer.innerHTML = `<div class="text-center text-red-400 p-4">Error: Could not connect to the backend server.</div>`;
      console.error(err);
    }
  });

  searchPlayerBtn.addEventListener('click', async () => {
    loadingIndicator.classList.remove('hidden'); playerSearchRecommendations.innerHTML=''; recommendationsContainer.innerHTML='';
    const playerName = document.getElementById('playerNameSearch').value;
    if (!playerName) { loadingIndicator.classList.add('hidden'); playerSearchRecommendations.innerHTML = `<div class="text-center text-gray-400 p-4">Please enter a player name.</div>`; return; }
    try {
      const res = await fetch(`${BACKEND_URL}/api/search_player`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({player_name: playerName}) });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      loadingIndicator.classList.add('hidden');
      displaySearchResults(data || [], playerSearchRecommendations);
    } catch (err) {
      loadingIndicator.classList.add('hidden');
      playerSearchRecommendations.innerHTML = `<div class="text-center text-red-400 p-4">Error: Could not connect to the backend server.</div>`;
      console.error(err);
    }
  });

  function displaySearchResults(players, container) {
    container.innerHTML = '';
    if (!players.length) { container.innerHTML = `<div class="text-center text-gray-400 p-4">No players found matching your search.</div>`; return; }
    players.forEach(player => {
      const card = document.createElement('div');
      card.className = 'bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-600 text-center cursor-pointer';
      card.innerHTML = `<div class="text-xl font-bold text-green-400 mb-1">${player.short_name}</div><div class="text-gray-300">${player.club_position} | OVR: ${player.overall}</div><div class="text-gray-400">Value: Â£${(player.value_eur/1000000).toFixed(1)}M</div>`;
      card.addEventListener('click', ()=>showPlayerModal(player));
      container.appendChild(card);
    });
  }

  function displayRecommendations(players, container) {
    container.innerHTML = '';
    if (!players || !players.length) { container.innerHTML = `<div class="text-center text-gray-400 p-4">No players found matching your criteria.</div>`; return; }
    players.forEach(player => {
      const card = document.createElement('div');
      card.className = 'bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-600 flex flex-col items-center text-center cursor-pointer';
      card.innerHTML = `
        <img src="${player.player_face_url}" alt="${player.short_name}" class="w-24 h-24 rounded-full mb-4 border-2 border-green-500">
        <div class="text-xl font-bold text-green-400 mb-1">${player.short_name}</div>
        <div class="text-gray-300">${player.club_position} | OVR: ${player.overall}</div>
        <div class="text-gray-400">Value: Â£${(player.value_eur/1000000).toFixed(1)}M</div>`;
      card.addEventListener('click', ()=>showPlayerModal(player));
      container.appendChild(card);
    });
  }

  const modal = document.getElementById('playerModal');
  const closeBtn = modal.querySelector('.close-button');
  const modalContent = document.getElementById('modalContent');
  closeBtn.onclick = () => modal.style.display = 'none';
  window.onclick = (e) => { if (e.target === modal) modal.style.display='none'; };

  function showPlayerModal(player) {
    let attributesHtml = '';
    const attrs = player.full_attributes || {};
    for (const k in attrs) {
      let v = attrs[k];
      let label = k.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
      if ((k.toLowerCase().includes('value') || k.toLowerCase().includes('wage')) && typeof v === 'number') {
        if (v >= 1000000) v = 'Â£' + (v/1000000).toFixed(2) + 'M';
        else v = 'Â£' + v.toLocaleString('en-GB');
      }
      attributesHtml += `<div class="flex justify-between py-1 border-b border-gray-600"><span class="font-semibold">${label}:</span> <span>${v}</span></div>`;
    }
    modalContent.innerHTML = `<div class="flex flex-col items-center mb-4"><img src="${player.player_face_url}" class="w-24 h-24 rounded-full border-2 border-green-500"><div class="text-2xl font-bold mt-4">${player.short_name}</div><div class="text-lg text-gray-400">${player.club_position} | OVR: ${player.overall} | POT: ${player.potential}</div><div class="text-md text-green-300 mt-1">Value: Â£${(player.value_eur/1000000).toFixed(1)}M</div></div><div class="overflow-y-auto max-h-96">${attributesHtml}</div>`;
    modal.style.display='block';
  }

  // init
  generateDynamicSliders();
});
</script>
</body>
</html>
